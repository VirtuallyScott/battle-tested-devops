# IaC Security Scan Shell Script

This document describes how the `iac_scan.sh` shell script works, what it does, and how to use it effectively.

---

## üîç Purpose

This script is a unified tool for scanning Infrastructure as Code (IaC) directories using:
- [Trivy](https://github.com/aquasecurity/trivy)
- [Checkov](https://www.checkov.io/1.Welcome/Quick%20Start.html)

It supports generating reports in multiple formats including:
- JSON
- SARIF
- HTML (via [snyk-to-html](https://docs.snyk.io/snyk-cli/cli-tools/snyk-to-html))
- CSV

---

## ‚öôÔ∏è Features

- Scans the current directory for IaC vulnerabilities and misconfigurations.
- Supports `Trivy`, `Checkov`, or both tools.
- Outputs can be in `json`, `sarif`, `html`, or `csv`.
- Automatically creates a `scans/` folder to store all outputs.
- Verifies if required tools are installed, prompts for installation if missing.
- Converts SARIF to HTML if requested using `snyk-to-html`.
- Replaces default Snyk HTML titles and references with the appropriate tool name (e.g., "Trivy Scan", "Checkov Scan") and scanned directory.
- **Quiet Operation**: Both Trivy and Checkov run with quiet flags to suppress verbose output and errors from stdout/stderr.
- **Soft-fail Mode**: Checkov runs with `--soft-fail` to prevent exit on findings, allowing continued processing.

---

## üß™ Usage

```bash
bash iac_scanner.sh -t <tool> -o <output_format>
```

### Arguments

| Flag         | Description |
|--------------|-------------|
| `-t`         | Type of scan: `trivy`, `checkov`, `both` |
| `-o`         | Output format: `json`, `sarif`, `html`, `csv` |
| `--help`     | Show usage instructions |

### Examples

- Run both scanners and output HTML reports:
  ```bash
  bash iac_scanner.sh -t both -o html
  ```

- Run only Trivy with JSON output:
  ```bash
  bash iac_scanner.sh -t trivy -o json
  ```

- Run Checkov and generate SARIF output:
  ```bash
  bash iac_scanner.sh -t checkov -o sarif
  ```

- Run both scanners and generate CSV output:
  ```bash
  bash iac_scanner.sh -t both -o csv
  ```

---

## üì¶ Requirements

This script depends on:

- [Trivy](https://github.com/aquasecurity/trivy) - installed via Homebrew
- [Checkov](https://www.checkov.io) - installed via pip
- [snyk-to-html](https://docs.snyk.io/snyk-cli/scan-and-maintain-projects-using-the-cli/cli-tools/snyk-to-html) - installed via npm

### Install commands

```bash
# For macOS/Linux
brew install trivy
brew install checkov
npm install -g snyk-to-html

# For other systems, see:
# Trivy: https://aquasecurity.github.io/trivy/latest/docs/installation/
# Checkov: https://www.checkov.io/1.Welcome/Quick%20Start.html
# snyk-to-html: https://docs.snyk.io/snyk-cli/cli-tools/snyk-to-html
```

---

## üìÅ Output Location & File Formats

All scan results will be saved in a `scans/` subdirectory created in the working directory. Filenames use this format:

```
<epochtime>__<tool>_<directoryname>.<ext>
```

### Output Format Details

| Format | Description | File Extension | Tools Supported |
|--------|-------------|----------------|-----------------|
| **JSON** | Machine-readable structured data | `.json` | Trivy, Checkov |
| **SARIF** | Static Analysis Results Interchange Format | `.sarif` | Trivy, Checkov |
| **HTML** | Human-readable web report | `.html` | Trivy, Checkov (via SARIF conversion) |
| **CSV** | Comma-separated values for spreadsheet analysis | `.csv` | Checkov only |

### Example Output Files

```
scans/1751568959__trivy_ansible_domain.json
scans/1751568959__trivy_ansible_domain.sarif
scans/1751568959__trivy_ansible_domain.html
scans/1751568959__checkov_ansible_domain.json
scans/1751568959__checkov_ansible_domain.sarif
scans/1751568959__checkov_ansible_domain.html
scans/1751568959__checkov_ansible_domain.csv
```

### HTML Report Features

- **Converted from SARIF**: HTML reports are generated by converting SARIF output using `snyk-to-html`
- **Custom Branding**: All "Snyk" references are replaced with the appropriate tool name (e.g., "Trivy Scan", "Checkov Scan")
- **Directory Context**: Report titles include the scanned directory name for easy identification

---

## üìù Notes

### Tool-Specific Behavior

- **Checkov Configuration**:
  - Runs with `--quiet --soft-fail` flags to suppress verbose output and prevent exit on findings
  - Creates files with specific naming patterns:
    - SARIF: `results_sarif.sarif`
    - JSON: `results_json.json` 
    - CSV: `results_csv.csv`
  - The script automatically renames these to match our epochtime naming convention

- **Trivy Configuration**:
  - Runs with `--quiet` flag and stderr redirected to `/dev/null` to suppress verbose output
  - Directly outputs to the specified filename format

- **HTML Conversion**: 
  - HTML reports are generated by first creating SARIF output, then converting with `snyk-to-html`
  - All "Snyk" branding is replaced with the appropriate tool name and scan context
  - Works for both Trivy and Checkov SARIF outputs

- **Error Handling**:
  - Both tools run in quiet mode to keep stdout clean for CI/CD integration
  - Checkov uses soft-fail mode to continue processing even when issues are found
  - Trivy errors are suppressed but scan failures are still detected and reported

### Requirements

- If any required tool is missing, the script will exit with an error message
- All three tools (trivy, checkov, snyk-to-html) must be installed for full functionality
- CSV output is only supported by Checkov

---

## üí¨ Help

Run:

```bash
bash iac_scanner.sh --help
```

To see built-in usage instructions.

---
